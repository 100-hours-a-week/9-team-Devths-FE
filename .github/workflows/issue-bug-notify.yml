name: Bug Issue Discord ì•Œë¦¼

on:
  issues:
    types: [opened, reopened] # ë‹¤ì‹œ ì—´ë¦° ì´ìŠˆë„ í¬í•¨

jobs:
  notify-bug-issue:
    runs-on: ubuntu-22.04
    if: contains(github.event.issue.labels.*.name, 'bug')
    steps:
      - name: ë°ì´í„° ì¤€ë¹„
        id: prep
        env:
          USER_MAP: ${{ secrets.USER_MAP_JSON }}
        run: |
          # 1. ë©˜ì…˜ ì²˜ë¦¬ í•¨ìˆ˜ (ì‚¬ìš©ì ë§¤í•‘ ë¡œì§ ê°•í™”)
          get_mention() {
            local login=$1
            local mapped=$(echo "$USER_MAP" | jq -r --arg id "$login" '.[$id] // empty')
            if [ -n "$mapped" ]; then echo "$mapped"; else echo "@$login"; fi
          }

          # 2. ì‘ì„±ì ë° ë‹´ë‹¹ì ë©˜ì…˜ ìƒì„±
          AUTHOR=$(get_mention "${{ github.event.issue.user.login }}")
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT

          ASSIGNEES=$(echo '${{ toJson(github.event.issue.assignees) }}' | jq -r --argjson map "$USER_MAP" '
            [.[].login | ($map[.] // "@" + .)] | join(", ")
          ')
          echo "assignees=${ASSIGNEES:-'ë¯¸ì§€ì • ğŸ‘¤'}" >> $GITHUB_OUTPUT

          # 3. ë¼ë²¨ì„ ì˜ˆì˜ê²Œ í¬ë§·íŒ… (ì˜ˆ: `bug`, `p0`)
          LABELS=$(echo '${{ toJson(github.event.issue.labels.*.name) }}' | jq -r 'map("`" + . + "`") | join(", ")')
          echo "labels=$LABELS" >> $GITHUB_OUTPUT

      - name: Discord ì•Œë¦¼ ì „ì†¡
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_BUG_URL }}
          # ìƒíƒœê°€ failureê°€ ì•„ë‹ˆë”ë¼ë„ ì»¤ìŠ¤í…€ ì»¬ëŸ¬ë¥¼ ì“°ê¸° ìœ„í•´ 'comment' ëª¨ë“œ ì‚¬ìš©
          status: 'comment'
          title: "ğŸš¨ BUG REPORT: ${{ github.event.issue.title }}"
          url: ${{ github.event.issue.html_url }}
          # íŠ¹ì • ì—­í• (@QA, @Dev)ì„ ë§¨ ìœ„ì— ì–¸ê¸‰í•˜ì—¬ ì¦‰ì‹œ ì•Œë¦¼ ìœ ë„
          content: "${{ secrets.DISCORD_ROLE_ID }} ë²„ê·¸ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. í™•ì¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤!"
          description: |
            **Reporter**
            ${{ steps.prep.outputs.author }}

            **Assignees**
            ${{ steps.prep.outputs.assignees }}

            **Labels**
            ${{ steps.prep.outputs.labels }}

            **Description Snippet**
            ```text
            ${{ github.event.issue.body }}
            ```
          color: 0xff4d4d # ì„ ëª…í•œ ë¹¨ê°„ìƒ‰
          username: "Devths Bug Sentinel"
          avatar_url: "https://cdn-icons-png.flaticon.com/512/1022/1022300.png" # ë²„ê·¸ ì•„ì´ì½˜
          footer: "Issue #${{ github.event.issue.number }} â€¢ ${{ github.event.repository.full_name }}"