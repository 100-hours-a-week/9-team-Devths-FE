name: Devths-FE Release ìë™í™”

on:
  push:
    branches:
      - 'release/*'
      - 'main'

permissions:
  contents: write
  pull-requests: read

jobs:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # release/* ë¸Œëœì¹˜: RC Prerelease ìƒì„±/ì—…ë°ì´íŠ¸
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  release-candidate:
    name: RC Prerelease ì—…ë°ì´íŠ¸
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/heads/release/')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: RC Prerelease ìƒì„±/ì—…ë°ì´íŠ¸
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = context.ref.replace('refs/heads/', '');
            const versionMatch = branchName.match(/release\/(v\d+\.\d+\.\d+)/);

            if (!versionMatch) {
              core.setFailed(`âŒ ë¸Œëœì¹˜ëª…ì—ì„œ ë²„ì „ì„ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${branchName}`);
              return;
            }

            const version = versionMatch[1];
            const rcTag = `${version}-rc`;

            console.log(`ğŸ“¦ Release ë²„ì „: ${version}`);
            console.log(`ğŸ·ï¸ RC íƒœê·¸: ${rcTag}`);

            let latestMainTag = null;
            try {
              const { data: tags } = await github.rest.repos.listTags({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              });
              const mainTags = tags.filter(tag => /^v\d+\.\d+\.\d+$/.test(tag.name));
              if (mainTags.length > 0) {
                latestMainTag = mainTags[0].name;
                console.log(`âœ… main ìµœì‹  íƒœê·¸: ${latestMainTag}`);
              }
            } catch (error) {
              console.log(`âš ï¸ íƒœê·¸ ì¡°íšŒ ì˜¤ë¥˜: ${error.message}`);
            }

            const generateNotesParams = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: rcTag,
              target_commitish: branchName
            };
            if (latestMainTag) generateNotesParams.previous_tag_name = latestMainTag;

            const { data: releaseNotes } = await github.rest.repos.generateReleaseNotes(generateNotesParams);

            const rcBody = `> âš ï¸ **ì£¼ì˜: ì´ê²ƒì€ ë¦´ë¦¬ì¦ˆ í›„ë³´(Release Candidate) ë²„ì „ì…ë‹ˆë‹¤.**\n` +
                           `> ìµœì¢… ë¦´ë¦¬ì¦ˆëŠ” \`main\` ë¸Œëœì¹˜ ë¨¸ì§€ í›„ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.\n\n` +
                           `${releaseNotes.body}\n\n` +
                           `---\n` +
                           `**ğŸ“ ë² ì´ìŠ¤ ë¸Œëœì¹˜**: \`${branchName}\`\n` +
                           `**ğŸ“Œ ì´ì „ íƒœê·¸**: \`${latestMainTag || 'N/A'}\`\n` +
                           `**ğŸ”„ ìë™ ìƒì„±**: GitHub Release Notes API`;

            let existingRelease = null;
            try {
              const { data: release } = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: rcTag
              });
              existingRelease = release;
            } catch (error) {
              if (error.status !== 404) throw error;
            }

            if (existingRelease) {
              await github.rest.repos.updateRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: existingRelease.id,
                name: `${version} (RC)`,
                body: rcBody,
                prerelease: true,
                target_commitish: branchName
              });
            } else {
              await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: rcTag,
                name: `${version} (RC)`,
                body: rcBody,
                prerelease: true,
                target_commitish: branchName
              });
            }

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # main ë¸Œëœì¹˜: ì •ì‹ Release ë°°í¬
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  production-release:
    name: ì •ì‹ Release ë°°í¬
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ì •ì‹ Release ìƒì„±
        uses: actions/github-script@v7
        with:
          script: |
            const commitMessage = context.payload.head_commit?.message || '';
            const commitVersionMatch = commitMessage.match(/release\/(v\d+\.\d+\.\d+)/);

            if (!commitVersionMatch) {
              console.log("âš ï¸ ë¨¸ì§€ ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ ë²„ì „ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë°°í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.");
              return;
            }

            const newVersion = commitVersionMatch[1];
            let latestMainTag = null;

            try {
              const { data: tags } = await github.rest.repos.listTags({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              });
              const mainTags = tags.filter(tag => /^v\d+\.\d+\.\d+$/.test(tag.name));
              if (mainTags.length > 0) latestMainTag = mainTags[0].name;
            } catch (error) {
              console.log(`âš ï¸ íƒœê·¸ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`);
            }

            const { data: releaseNotes } = await github.rest.repos.generateReleaseNotes({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: newVersion,
              target_commitish: 'main',
              previous_tag_name: latestMainTag || undefined
            });

            const { data: release } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: newVersion,
              name: newVersion,
              body: releaseNotes.body,
              draft: false,
              prerelease: false,
              target_commitish: 'main'
            });

            console.log(`âœ… ì •ì‹ Release ìƒì„± ì™„ë£Œ: ${release.html_url}`);
