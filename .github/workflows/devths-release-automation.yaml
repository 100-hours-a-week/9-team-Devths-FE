name: Devths-FE Release ìë™í™”

on:
  push:
    branches:
      - release/*
      - main

permissions:
  contents: write
  pull-requests: read

jobs:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # release/* ë¸Œëœì¹˜: RC Prerelease ìƒì„±/ì—…ë°ì´íŠ¸
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  release-candidate:
    name: RC Prerelease ì—…ë°ì´íŠ¸
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/heads/release/')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (íƒœê·¸ í¬í•¨)

      - name: RC Prerelease ìƒì„±/ì—…ë°ì´íŠ¸
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            // 1. ë¸Œëœì¹˜ëª…ì—ì„œ ë²„ì „ ì¶”ì¶œ (release/v1.2.0 -> v1.2.0)
            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            const branchName = context.ref.replace('refs/heads/', '');
            const versionMatch = branchName.match(/release\/(v\d+\.\d+\.\d+)/);

            if (!versionMatch) {
              core.setFailed(`âŒ ë¸Œëœì¹˜ëª…ì—ì„œ ë²„ì „ì„ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${branchName}`);
              core.setFailed(`ğŸ’¡ ë¸Œëœì¹˜ëª… í˜•ì‹: release/vX.Y.Z (ì˜ˆ: release/v1.2.0)`);
              return;
            }

            const version = versionMatch[1];
            const rcTag = `${version}-rc`;

            console.log(`ğŸ“¦ Release ë²„ì „: ${version}`);
            console.log(`ğŸ·ï¸  RC íƒœê·¸: ${rcTag}`);

            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            // 2. main ë¸Œëœì¹˜ì˜ ìµœì‹  íƒœê·¸ ì°¾ê¸°
            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            let latestMainTag = null;

            try {
              // main ë¸Œëœì¹˜ì˜ ëª¨ë“  íƒœê·¸ ê°€ì ¸ì˜¤ê¸°
              const { data: tags } = await github.rest.repos.listTags({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              });

              // vX.Y.Z í˜•ì‹ì˜ ì •ì‹ íƒœê·¸ë§Œ í•„í„°ë§ (RC ì œì™¸)
              const mainTags = tags.filter(tag =>
                /^v\d+\.\d+\.\d+$/.test(tag.name)
              );

              if (mainTags.length > 0) {
                latestMainTag = mainTags[0].name;
                console.log(`âœ… main ìµœì‹  íƒœê·¸: ${latestMainTag}`);
              } else {
                console.log(`âš ï¸  main ë¸Œëœì¹˜ì— íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤. ì „ì²´ íˆìŠ¤í† ë¦¬ë¥¼ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ì— í¬í•¨í•©ë‹ˆë‹¤.`);
              }
            } catch (error) {
              console.log(`âš ï¸  íƒœê·¸ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜: ${error.message}`);
            }

            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            // 3. GitHub Generate Release Notes API í˜¸ì¶œ
            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            console.log(`\nğŸ“ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„± ì¤‘...`);

            const generateNotesParams = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: rcTag,
              target_commitish: branchName
            };

            if (latestMainTag) {
              generateNotesParams.previous_tag_name = latestMainTag;
            }

            const { data: releaseNotes } = await github.rest.repos.generateReleaseNotes(
              generateNotesParams
            );

            console.log(`âœ… ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„± ì™„ë£Œ`);

            // ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ì— RC ì•ˆë‚´ ì¶”ê°€
            const rcBody = `> âš ï¸ **ì£¼ì˜: ì´ê²ƒì€ ë¦´ë¦¬ì¦ˆ í›„ë³´(Release Candidate) ë²„ì „ì…ë‹ˆë‹¤.**
> ìµœì¢… ë¦´ë¦¬ì¦ˆëŠ” \`main\` ë¸Œëœì¹˜ ë¨¸ì§€ í›„ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.

${releaseNotes.body}

---
**ğŸ“ ë² ì´ìŠ¤ ë¸Œëœì¹˜**: \`${branchName}\`
**ğŸ“Œ ì´ì „ íƒœê·¸**: \`${latestMainTag || 'N/A (ìµœì´ˆ ë¦´ë¦¬ì¦ˆ)'}\`
**ğŸ”„ ìë™ ìƒì„±**: GitHub Release Notes API`;

            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            // 4. ê¸°ì¡´ RC Release ì°¾ê¸°
            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            console.log(`\nğŸ” ê¸°ì¡´ RC Release í™•ì¸ ì¤‘...`);

            let existingRelease = null;
            try {
              const { data: release } = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: rcTag
              });
              existingRelease = release;
              console.log(`âœ… ê¸°ì¡´ RC Release ë°œê²¬: ${release.html_url}`);
            } catch (error) {
              if (error.status === 404) {
                console.log(`â„¹ï¸  ê¸°ì¡´ RC Release ì—†ìŒ (ìƒˆë¡œ ìƒì„±)`);
              } else {
                throw error;
              }
            }

            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            // 5. RC Release ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸
            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            let releaseUrl;

            if (existingRelease) {
              // ì—…ë°ì´íŠ¸
              console.log(`\nâ™»ï¸  RC Release ì—…ë°ì´íŠ¸ ì¤‘...`);

              const { data: updatedRelease } = await github.rest.repos.updateRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: existingRelease.id,
                tag_name: rcTag,
                name: `${version} (Release Candidate)`,
                body: rcBody,
                draft: true,
                prerelease: true,
                target_commitish: branchName
              });

              releaseUrl = updatedRelease.html_url;
              console.log(`âœ… RC Release ì—…ë°ì´íŠ¸ ì™„ë£Œ`);
            } else {
              // ìƒˆë¡œ ìƒì„±
              console.log(`\nğŸ“¦ RC Release ìƒì„± ì¤‘...`);

              const { data: newRelease } = await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: rcTag,
                name: `${version} (Release Candidate)`,
                body: rcBody,
                draft: true,
                prerelease: true,
                target_commitish: branchName
              });

              releaseUrl = newRelease.html_url;
              console.log(`âœ… RC Release ìƒì„± ì™„ë£Œ`);
            }

            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            // 6. ê²°ê³¼ ì¶œë ¥
            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            console.log(`\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);
            console.log(`âœ… RC Release ì¤€ë¹„ ì™„ë£Œ`);
            console.log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);
            console.log(`ğŸ“¦ ë²„ì „: ${version}`);
            console.log(`ğŸ·ï¸  íƒœê·¸: ${rcTag}`);
            console.log(`ğŸ”— URL: ${releaseUrl}`);
            console.log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);

            core.setOutput('version', version);
            core.setOutput('rc_tag', rcTag);
            core.setOutput('release_url', releaseUrl);

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # main ë¸Œëœì¹˜: ì •ì‹ Release ë°°í¬ + RC ì •ë¦¬
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  production-release:
    name: ì •ì‹ Release ë°°í¬
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ì •ì‹ Release ìƒì„±
        uses: actions/github-script@v7
        with:
          script: |
            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            // 1. ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ ë²„ì „ ì¶”ì¶œ (í•„ìˆ˜)
            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            console.log(`ğŸ” ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ ë²„ì „ ê°ì§€ ì¤‘...`);

            const commitMessage = context.payload.head_commit?.message || '';
            const commitVersionMatch = commitMessage.match(/release\/(v\d+\.\d+\.\d+)/);

            if (!commitVersionMatch) {
              core.setFailed(`âŒ ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ ë²„ì „ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
              core.setFailed(`ğŸ’¡ release/* ë¸Œëœì¹˜ë¥¼ mainì— ë¨¸ì§€í•˜ì„¸ìš”. (ì˜ˆ: release/v1.2.0)`);
              core.setFailed(`ğŸ“‹ í˜„ì¬ ì»¤ë°‹ ë©”ì‹œì§€: ${commitMessage}`);
              return;
            }

            const newVersion = commitVersionMatch[1];
            console.log(`âœ… ë°°í¬ ë²„ì „: ${newVersion}`);

            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            // 2. mainì˜ ìµœì‹  íƒœê·¸ ì°¾ê¸° (ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±ìš©)
            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            console.log(`\nğŸ” ì´ì „ ë¦´ë¦¬ì¦ˆ íƒœê·¸ í™•ì¸ ì¤‘...`);

            let latestMainTag = null;

            try {
              const { data: tags } = await github.rest.repos.listTags({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              });

              // vX.Y.Z í˜•ì‹ì˜ ì •ì‹ íƒœê·¸ë§Œ í•„í„°ë§
              const mainTags = tags.filter(tag =>
                /^v\d+\.\d+\.\d+$/.test(tag.name)
              );

              if (mainTags.length > 0) {
                latestMainTag = mainTags[0].name;
                console.log(`âœ… ì´ì „ íƒœê·¸: ${latestMainTag}`);
              } else {
                console.log(`â„¹ï¸  ìµœì´ˆ ë¦´ë¦¬ì¦ˆ (ì´ì „ íƒœê·¸ ì—†ìŒ)`);
              }
            } catch (error) {
              console.log(`âš ï¸  íƒœê·¸ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`);
            }

            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            // 3. ë™ì¼ ë²„ì „ ë¦´ë¦¬ì¦ˆ ì¤‘ë³µ í™•ì¸
            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            try {
              const { data: existingRelease } = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: newVersion
              });

              if (!existingRelease.draft && !existingRelease.prerelease) {
                console.log(`âš ï¸  ${newVersion} ì •ì‹ ë¦´ë¦¬ì¦ˆê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.`);
                console.log(`ğŸ”— ${existingRelease.html_url}`);
                console.log(`â„¹ï¸  ì¤‘ë³µ ë¦´ë¦¬ì¦ˆ ìƒì„±ì„ ê±´ë„ˆëœë‹ˆë‹¤.`);
                return;
              }
            } catch (error) {
              if (error.status !== 404) {
                throw error;
              }
              // 404ëŠ” ì •ìƒ (ë¦´ë¦¬ì¦ˆ ì—†ìŒ)
            }

            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            // 4. GitHub Generate Release Notes API í˜¸ì¶œ
            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            console.log(`\nğŸ“ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„± ì¤‘...`);

            const generateNotesParams = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: newVersion,
              target_commitish: 'main'
            };

            if (latestMainTag) {
              generateNotesParams.previous_tag_name = latestMainTag;
            }

            const { data: releaseNotes } = await github.rest.repos.generateReleaseNotes(
              generateNotesParams
            );

            console.log(`âœ… ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„± ì™„ë£Œ`);

            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            // 5. ì •ì‹ Release ìƒì„± (Publish)
            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            console.log(`\nğŸš€ ì •ì‹ Release ìƒì„± ì¤‘...`);

            const { data: release } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: newVersion,
              name: releaseNotes.name || newVersion,
              body: releaseNotes.body,
              draft: false,
              prerelease: false,
              target_commitish: 'main'
            });

            console.log(`âœ… ì •ì‹ Release ìƒì„± ì™„ë£Œ`);
            console.log(`ğŸ”— ${release.html_url}`);

            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            // 6. ê²°ê³¼ ì¶œë ¥
            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            console.log(`\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);
            console.log(`ğŸ‰ ì •ì‹ Release ë°°í¬ ì™„ë£Œ`);
            console.log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);
            console.log(`ğŸ“¦ ë²„ì „: ${newVersion}`);
            console.log(`ğŸ”— URL: ${release.html_url}`);
            console.log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);

            core.setOutput('version', newVersion);
            core.setOutput('release_url', release.html_url);
