name: Devths-FE CICD íŒŒì´í”„ë¼ì¸

on:
  push:
    branches: [develop, release, main]

env:
  NODE_VERSION: '22.x'
  AWS_REGION: ${{ secrets.AWS_REGION }}
  S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
  S3_PREFIX: ci/${{ github.repository }}/${{ github.ref_name }}/${{ github.sha }}

jobs:
  # 1. í†µí•© í’ˆì§ˆ ê²€ì‚¬ (Lint + Prettier + TypeCheck)
  lint:
    runs-on: ubuntu-22.04
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v3
        with:
          version: 9 # í”„ë¡œì íŠ¸ í™˜ê²½ì— ë§ëŠ” ë²„ì „ ì„¤ì •
          run_install: false

      - name: ë…¸ë“œ JS ì„¤ì¹˜
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: í†µí•© ì½”ë“œ ê²€ì‚¬
        run: pnpm check # í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•˜ë©´ ì—¬ê¸°ì„œ ë©ˆì¶¤

  # 2. ì •ì  ë¶„ì„ (CodeQL)
  static-analysis:
    needs: [lint]
    runs-on: ubuntu-22.04
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: CodeQL ì´ˆê¸°í™”
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript
      - name: ë¶„ì„ ìˆ˜í–‰
        uses: github/codeql-action/analyze@v3

  # 3. ë¹Œë“œ ë° S3 ì—…ë¡œë“œ
  build:
    needs: [static-analysis]
    runs-on: ubuntu-22.04
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: ë…¸ë“œ JS ì„¤ì¹˜
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: í”„ë¡œì íŠ¸ ë¹Œë“œ
        run: pnpm build

      - name: AWS ìê²© ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{secrets.AWS_ACCESS_KEY}}
          aws-secret-access-key: ${{secrets.AWS_SECRET_KEY}}
          aws-region: ${{secrets.AWS_REGION}}

      - name: S3ì— ë¹Œë“œ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ
        run: |
          # 1. Next.js ë¹Œë“œ ê²°ê³¼ë¬¼ ê²½ë¡œ ê°ì§€
          if [ -d "./.next" ]; then
            SOURCE_DIR="./.next"
          elif [ -d "./out" ]; then
            SOURCE_DIR="./out"
          else
            echo "âŒ ë¹Œë“œ í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

          # 2. S3 ìµœì¢… ê²½ë¡œ ì„¤ì •
          DEST_URL="s3://${{ env.S3_BUCKET }}/${{ env.S3_PREFIX }}"

          echo "ğŸš€ $SOURCE_DIR í´ë”ì˜ íŒŒì¼ë“¤ì„ $DEST_URL ê²½ë¡œë¡œ ì „ì†¡í•©ë‹ˆë‹¤."

          # sync ëª…ë ¹ì–´ë¡œ ë¡œì»¬ê³¼ S3ë¥¼ ë™ì¼í•˜ê²Œ ë§ì¶¤
          # --delete ì˜µì…˜ì€ ë¡œì»¬ì— ì—†ëŠ” íŒŒì¼ì´ S3ì— ìˆë‹¤ë©´ ì‚­ì œí•˜ì—¬ ë™ê¸°í™”í•©ë‹ˆë‹¤.
          aws s3 sync $SOURCE_DIR $DEST_URL --delete --only-show-errors
      # --------------------------------

  # 4. ë””ìŠ¤ì½”ë“œ í†µí•© ì•Œë¦¼
  notify-discord:
    runs-on: ubuntu-22.04
    needs: [lint, static-analysis, build]
    if: always()
    steps:
      - name: ë°ì´í„° ì¤€ë¹„
        id: prep
        env:
          USER_MAP: ${{ secrets.USER_MAP_JSON }}
        run: |
          # 1. ì‘ì„±ì ë©˜ì…˜í™”
          LOGIN_ID="${{ github.event.push.user.login }}"
          AUTHOR_RAW=$(echo "$USER_MAP" | jq -r --arg id "$LOGIN_ID" '.[$id] // $id')
          [[ $AUTHOR_RAW =~ (<@[^>]+>) ]] && AUTHOR_TAG="${BASH_REMATCH[1]}" || AUTHOR_TAG="$AUTHOR_RAW"
          echo "author=$AUTHOR_TAG" >> $GITHUB_OUTPUT

      - name: Discord ì•Œë¦¼ ì „ì†¡
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: ${{ (needs.lint.result == 'success' && needs.static-analysis.result == 'success' && needs.build.result == 'success') && 'success' || 'failure' }}
          title: "${{ github.event.pull_request.base.ref }} FE PR [${{ (needs.lint.result == 'success' && needs.static-analysis.result == 'success' && needs.build.result == 'success') && 'âœ…ì„±ê³µ' || 'âŒì‹¤íŒ¨' }}]"
          description: |
            **ì‘ì„±ì**: ${{ steps.prep.outputs.author }}
            **ë¦¬ë·°ì–´**: ${{ steps.prep.outputs.reviewers }}

            **ğŸ“Š ìƒì„¸ ê²°ê³¼**:
            - Lint/Type: ${{ needs.lint.result == 'success' && ' âœ…' || ' âŒ' }}
            - Static Analysis: ${{ needs.static-analysis.result == 'success' && ' âœ…' || ' âŒ' }}
            - Build: ${{ needs.build.result == 'success' && ' âœ…' || ' âŒ' }}

            **ğŸ”— ë§í¬**: [PR í™•ì¸í•˜ê¸°](${{ github.event.pull_request.html_url }})
          color: "${{ (needs.lint.result == 'success' && needs.static-analysis.result == 'success' && needs.build.result == 'success') && 65280 || 16711680 }}"
          username: GitHub FE Bot
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
