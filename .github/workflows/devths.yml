name: Devths-FE CICD íŒŒì´í”„ë¼ì¸

on:
  push:
    branches: [develop, release, main]

env:
  NODE_VERSION: '22.x'
  AWS_REGION: ${{ secrets.AWS_REGION }}
  S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
  S3_PREFIX: FE/${{ github.ref_name }}

jobs:
  # 1. í†µí•© í’ˆì§ˆ ê²€ì‚¬ (Lint + Prettier + TypeCheck)
  lint:
    runs-on: ubuntu-22.04
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v3
        with:
          version: 9 # í”„ë¡œì íŠ¸ í™˜ê²½ì— ë§ëŠ” ë²„ì „ ì„¤ì •
          run_install: false

      - name: ë…¸ë“œ JS ì„¤ì¹˜
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: í†µí•© ì½”ë“œ ê²€ì‚¬
        run: pnpm check # í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•˜ë©´ ì—¬ê¸°ì„œ ë©ˆì¶¤

  # 2. ì •ì  ë¶„ì„ (CodeQL)
  static-analysis:
    runs-on: ubuntu-22.04
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: CodeQL ì´ˆê¸°í™”
        uses: github/codeql-action/init@v4
        with:
          languages: javascript-typescript

      - name: ë¶„ì„ ìˆ˜í–‰
        uses: github/codeql-action/analyze@v4

      - name: ë³´ì•ˆ ì·¨ì•½ì  ê°œìˆ˜ í™•ì¸ ë° ë¹Œë“œ ì°¨ë‹¨ (Push)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # 1. í˜„ì¬ Pushëœ ë¸Œëœì¹˜ ì •ë³´ (ì˜ˆ: refs/heads/main)
          TARGET_REF="${{ github.ref }}"
          echo "ğŸ“ ë¶„ì„ ëŒ€ìƒ ë¸Œëœì¹˜: $TARGET_REF"
          echo "ğŸ” CodeQL ë¶„ì„ ê²°ê³¼ ë°˜ì˜ í™•ì¸ ì¤‘..."

          ALERTS_JSON=""
          # 2. Polling ë¡œì§: ê²°ê³¼ ë°˜ì˜ ëŒ€ê¸°
          for i in {1..10}; do
            RESPONSE=$(gh api "repos/${{ github.repository }}/code-scanning/alerts?tool_name=CodeQL&state=open&ref=$TARGET_REF" || echo "")

            if [ -n "$RESPONSE" ] && [ "$RESPONSE" != "[]" ]; then
              ALERTS_JSON="$RESPONSE"
              echo "âœ… API ë°ì´í„° í™•ì¸ ì™„ë£Œ! ($((i*5))s ì†Œìš”)"
              break
            fi
            echo "â³ ë°ì´í„° ë°˜ì˜ ëŒ€ê¸° ì¤‘... ($((i*5))s)"
            sleep 5
          done

          # 3. ë°ì´í„°ê°€ ë¹„ì–´ìˆìœ¼ë©´ í†µê³¼
          if [ -z "$ALERTS_JSON" ] || [ "$ALERTS_JSON" == "[]" ]; then
            echo "âœ… ë³´ì•ˆ ê²€ì‚¬ í†µê³¼: ë°œê²¬ëœ ì·¨ì•½ì ì´ ì—†ìŠµë‹ˆë‹¤."
            exit 0
          fi

          # 4. ë³´ì•ˆ ë“±ê¸‰ì´ ìˆëŠ” ì·¨ì•½ì  ê°œìˆ˜ ì‚°ì¶œ
          ALERTS_COUNT=$(echo "$ALERTS_JSON" | jq -r "[.[] | select(.rule.security_severity_level != null)] | length")

          echo "âš ï¸ ë°œê²¬ëœ ì´ ë³´ì•ˆ ì·¨ì•½ì : $ALERTS_COUNTê°œ"

          if [ "$ALERTS_COUNT" -gt 0 ]; then
            echo ""
            echo "ğŸ“‹ ì·¨ì•½ì  ìƒì„¸ ëª©ë¡ (ì „ì²´ ì½”ë“œ):"
            echo "$ALERTS_JSON" | jq -r '.[] | select(.rule.security_severity_level != null) | "  - [\(.rule.security_severity_level)] \(.rule.description) \n    ìœ„ì¹˜: \(.most_recent_instance.location.path)"'

            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âŒ CRITICAL: ë¸Œëœì¹˜ì— ë³´ì•ˆ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

            # ë¹Œë“œ ë° S3 ì—…ë¡œë“œ ì¤‘ë‹¨ì„ ìœ„í•´ ì‹¤íŒ¨ ì¢…ë£Œ
            exit 1
          else
            echo "âœ… ë³´ì•ˆ ê²€ì‚¬ í†µê³¼! ëª¨ë“  ì½”ë“œê°€ ì•ˆì „í•©ë‹ˆë‹¤."
          fi

  # 3. ë¹Œë“œ ë° S3 ì—…ë¡œë“œ
  build:
    needs: [lint, static-analysis]
    runs-on: ubuntu-22.04
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: ë…¸ë“œ JS ì„¤ì¹˜
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: í”„ë¡œì íŠ¸ ë¹Œë“œ
        run: pnpm build

      - name: AWS ìê²© ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{secrets.AWS_ACCESS_KEY}}
          aws-secret-access-key: ${{secrets.AWS_SECRET_KEY}}
          aws-region: ${{secrets.AWS_REGION}}

      - name: íƒ€ì„ìŠ¤íƒ¬í”„ ìƒì„±
        id: timestamp
        run: |
          # SHAì˜ ì• 7ìë¦¬ë§Œ ë³€ìˆ˜ì— ì €ì¥
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          # ë‚ ì§œì™€ SHORT_SHAë¥¼ ê²°í•©í•˜ì—¬ OUTPUTì— ì €ì¥
          echo "value=$(date +'%Y%m%d_%H%M%S')-$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: S3ì— ë¹Œë“œ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ
        run: |
          # 1. Next.js ì •ì  ë¹Œë“œ ê²°ê³¼ë¬¼ ê²½ë¡œ í™•ì¸ (Static Exportìš©)
          if [ -d "./out" ]; then
            SOURCE_DIR="./out"
          elif [ -d "./.next" ]; then
            SOURCE_DIR="./.next"
            echo "âš ï¸ ê²½ê³ : .next í´ë”ëŠ” ì„œë²„ ì‹¤í–‰ìš©ì…ë‹ˆë‹¤. ì •ì  í˜¸ìŠ¤íŒ…ì—ëŠ” ./out í´ë”ê°€ í•„ìš”í•©ë‹ˆë‹¤."
          else
            echo "âŒ ë¹Œë“œ í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

          # 2. S3 ìµœì¢… ê²½ë¡œ ì„¤ì •
          DEST_URL="s3://${S3_BUCKET}/${S3_PREFIX}/${{ steps.timestamp.outputs.value }}"

          echo "ğŸš€ $SOURCE_DIR í´ë”ì˜ íŒŒì¼ë“¤ì„ $DEST_URL ê²½ë¡œë¡œ ì „ì†¡í•©ë‹ˆë‹¤."

          # 3. S3ì— ì •ì  ì›¹ì‚¬ì´íŠ¸ íŒŒì¼ ì—…ë¡œë“œ
          # --content-typeê³¼ --cache-control ì„¤ì •ìœ¼ë¡œ ì›¹ í˜¸ìŠ¤íŒ… ìµœì í™”
          aws s3 sync $SOURCE_DIR $DEST_URL \
            --delete \
            --only-show-errors \
            --metadata-directive REPLACE \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "*.html" \
            --exclude "*.json"

          # HTMLê³¼ JSON íŒŒì¼ì€ ìºì‹œ ì •ì±…ì„ ë‹¤ë¥´ê²Œ ì„¤ì • (ìì£¼ ë³€ê²½ë  ìˆ˜ ìˆìŒ)
          aws s3 sync $SOURCE_DIR $DEST_URL \
            --only-show-errors \
            --metadata-directive REPLACE \
            --cache-control "public, max-age=0, must-revalidate" \
            --include "*.html" \
            --include "*.json" \
            --content-type "text/html" \
            --exclude "*"

          echo "âœ… S3 ì—…ë¡œë“œ ì™„ë£Œ: $DEST_URL"
      # --------------------------------

  # 4. ë””ìŠ¤ì½”ë“œ í†µí•© ì•Œë¦¼
  notify-discord:
    runs-on: ubuntu-22.04
    needs: [lint, static-analysis, build]
    if: always()
    steps:
      - name: ë°ì´í„° ì¤€ë¹„
        id: prep
        env:
          USER_MAP: ${{ secrets.USER_MAP_JSON }}
        run: |
          # 1. ì»¤ë°‹ ë©”ì‹œì§€ ì¶”ì¶œ (Push ì œëª© ëŒ€ìš©)
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -n 1)
          echo "title=$COMMIT_MSG" >> $GITHUB_OUTPUT

          # 2. ë¸Œëœì¹˜ ì •ë³´
          echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT

      - name: Discord ì•Œë¦¼ ì „ì†¡
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ github.ref_name == 'main' && secrets.DISCORD_WEBHOOK_PROD_URL || secrets.DISCORD_WEBHOOK_NON_PROD_URL }}
          status: ${{ (needs.lint.result == 'success' && needs.static-analysis.result == 'success' && needs.build.result == 'success') && 'success' || 'failure' }}
          title: "${{ steps.prep.outputs.branch }} ê²°ê³¼ [${{ (needs.lint.result == 'success' && needs.static-analysis.result == 'success' && needs.build.result == 'success') && 'âœ…ì„±ê³µ' || 'âŒì‹¤íŒ¨' }}]"
          description: |
            **ì»¤ë°‹ ë©”ì‹œì§€**: ${{ steps.prep.outputs.title }}
            **ë¸Œëœì¹˜**: `${{ steps.prep.outputs.branch }}`
            **í™˜ê²½**: ${{ github.ref_name == 'main' && 'ğŸš€ ìš´ì˜(PROD)' || (github.ref_name == 'release' && 'ğŸ§ª ìŠ¤í…Œì´ì§•(STAGING)' || 'ğŸ› ï¸ ê°œë°œ(DEV)') }}

            **ğŸ“Š ìƒì„¸ ê²°ê³¼**:
            - Lint/Type: ${{ needs.lint.result == 'success' && ' âœ…' || ' âŒ' }}
            - Static Analysis: ${{ needs.static-analysis.result == 'success' && ' âœ…' || ' âŒ' }}
            - Build: ${{ needs.build.result == 'success' && ' âœ…' || ' âŒ' }}

            **ğŸ”— ë§í¬**: [ì»¤ë°‹ í™•ì¸í•˜ê¸°](${{ github.event.repository.html_url }}/commit/${{ github.sha }})

          color: "${{ (needs.lint.result == 'success' && needs.static-analysis.result == 'success' && needs.build.result == 'success') && 65280 || 16711680 }}"
          username: GitHub FE Merge Bot
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
