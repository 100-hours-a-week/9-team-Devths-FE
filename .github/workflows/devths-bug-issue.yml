name: Bug Issue Discord ì•Œë¦¼

on:
  issues:
    types: [opened, reopened] # ë‹¤ì‹œ ì—´ë¦° ì´ìŠˆë„ í¬í•¨

jobs:
  notify-bug-issue:
    runs-on: ubuntu-22.04
    if: contains(github.event.issue.labels.*.name, 'bug')
    steps:
      - name: ë°ì´í„° ì¤€ë¹„
        id: prep
        env:
          USER_MAP: ${{ secrets.USER_MAP_JSON }}
        run: |
          # 1. ë©˜ì…˜ ì²˜ë¦¬ í•¨ìˆ˜ (ì‚¬ìš©ì ë§¤í•‘ ë¡œì§ ê°•í™”)
          get_mention() {
            local login=$1
            local mapped=$(echo "$USER_MAP" | jq -r --arg id "$login" '.[$id] // empty')
            if [ -n "$mapped" ]; then echo "$mapped"; else echo "@$login"; fi
          }

          # 2. ì‘ì„±ì ë° ë‹´ë‹¹ì ë©˜ì…˜ ìƒì„±
          AUTHOR=$(get_mention "${{ github.event.issue.user.login }}")
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT

          ASSIGNEES=$(echo '${{ toJson(github.event.issue.assignees) }}' | jq -r --argjson map "$USER_MAP" '
            [.[].login | ($map[.] // "@" + .)] | join(", ")
          ')
          echo "assignees=${ASSIGNEES:-'ë¯¸ì§€ì • ğŸ‘¤'}" >> $GITHUB_OUTPUT

          # 3. ë¼ë²¨ì„ ì˜ˆì˜ê²Œ í¬ë§·íŒ… (ì˜ˆ: `bug`, `p0`)
          LABELS=$(echo '${{ toJson(github.event.issue.labels.*.name) }}' | jq -r 'map("`" + . + "`") | join(", ")')
          echo "labels=$LABELS" >> $GITHUB_OUTPUT

      - name: Discord ì•Œë¦¼ ì „ì†¡
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_BUG_URL }}
          status: 'failure'

          title: 'ğŸš¨ BUG REPORT: ${{ github.event.issue.title }}'
          url: ${{ github.event.issue.html_url }}

          # 2. ì—­í•  ë©˜ì…˜ì€ contentì— ê·¸ëŒ€ë¡œ ë‘ì–´ ìµœìƒë‹¨ì— ë…¸ì¶œë˜ê²Œ í•©ë‹ˆë‹¤.
          content: '${{ secrets.DISCORD_ROLE }} ë²„ê·¸ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. í™•ì¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤!'

          description: |
            **ë ˆí¬ì§€í† ë¦¬**
            ${{ github.event.repository.full_name }} (FE)

            **ì‘ì„±ì**
            ${{ steps.prep.outputs.author }}

            **ë‹´ë‹¹ì**
            ${{ steps.prep.outputs.assignees }}

            **ë¼ë²¨**
            ${{ steps.prep.outputs.labels }}

            **ğŸ“ ë‚´ìš©**
            ```text
            ${{ github.event.issue.body }}
            ```

          # 4. ê¸°íƒ€ ìŠ¤íƒ€ì¼ ì˜µì…˜
          color: 0xff4d4d
          username: GitHub FE Bug Bot
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
