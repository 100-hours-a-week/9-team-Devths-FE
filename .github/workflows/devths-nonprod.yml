name: Devths-FE ë¹„ìš´ì˜ìš© CICD íŒŒì´í”„ë¼ì¸

on:
  push:
    branches:
      - develop
      - release/*

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # ê³µí†µ ì„¤ì •
  NODE_VERSION: '22.x'
  BRANCH_NAME: ${{ github.ref_name }}
  IS_STAGING: ${{ startsWith(github.ref_name, 'release/') }}
  ENV_TYPE: ${{ startsWith(github.ref_name, 'release/') && 'ğŸ§ª ìŠ¤í…Œì´ì§•(STAGING)' || 'ğŸ› ï¸ ê°œë°œ(DEV)' }}

  # AWS ì„¤ì •
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_KEY }}
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REGISTRY: ${{ secrets.AWS_ECR_REGISTRY }}
  ECR_TARGET_REPO: "devths/fe-${{ startsWith(github.ref_name, 'release/') && 'stg' || 'dev'}}"
  S3_BUCKET: ${{ secrets.AWS_S3_BUCKET_V2 }}
  S3_PREFIX: FE/${{ github.ref_name }}

  # CodeDeploy ì„¤ì •
  CODEDEPLOY_APP_NAME: ${{ secrets.CODEDEPLOY_APP_NAME }}
  CODEDEPLOY_DEPLOYMENT_GROUP: ${{ startsWith(github.ref_name, 'release/') && secrets.CODE_DEPLOY_GROUP_NAME_STAGING_V2 || secrets.CODE_DEPLOY_GROUP_NAME_DEV_V2 }}

  # Discord ì„¤ì •
  DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_NON_PROD_URL }}
  DISCORD_AVATAR_URL: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png

jobs:
  # 1. í†µí•© í’ˆì§ˆ ê²€ì‚¬ (Lint + Prettier + TypeCheck)
  lint:
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v3
        with:
          version: 9 # í”„ë¡œì íŠ¸ í™˜ê²½ì— ë§ëŠ” ë²„ì „ ì„¤ì •
          run_install: false

      - name: ë…¸ë“œ JS ì„¤ì¹˜
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: í†µí•© ì½”ë“œ ê²€ì‚¬
        run: pnpm check # í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•˜ë©´ ì—¬ê¸°ì„œ ë©ˆì¶¤

  # 2. ì •ì  ë¶„ì„ (CodeQL)
  static-analysis:
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: CodeQL ì´ˆê¸°í™”
        uses: github/codeql-action/init@v4
        with:
          languages: javascript-typescript
          config-file: './.github/codeql/code-ql-heavy.yml'

      - name: ë¶„ì„ ìˆ˜í–‰
        uses: github/codeql-action/analyze@v4

      - name: ë³´ì•ˆ ì·¨ì•½ì  ê²°ê³¼ í™•ì¸ ë° ì°¨ë‹¨
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "â³ ë¶„ì„ ê²°ê³¼ê°€ GitHubì— ë°˜ì˜ë˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ (10ì´ˆ)..."
          sleep 10

          # 1. í˜„ì¬ ì´ë²¤íŠ¸ê°€ pushì¸ì§€ prì¸ì§€ì— ë”°ë¼ ê²€ìƒ‰í•  REF ì„¤ì •
          # GITHUB_REFëŠ” pushì¼ ë• refs/heads/branchëª…, PRì¼ ë• refs/pull/ë²ˆí˜¸/mergeê°€ ë©ë‹ˆë‹¤.
          CURRENT_REF="${{ github.ref }}"
          echo "ğŸ“ í˜„ì¬ Ref: $CURRENT_REF"

          # 2. API í˜¸ì¶œí•˜ì—¬ High/Critical ë“±ê¸‰ì˜ Open ìƒíƒœì¸ ì•Œë¦¼ ì¡°íšŒ
          ALERTS=$(gh api "repos/${{ github.repository }}/code-scanning/alerts?tool_name=CodeQL&state=open&ref=$CURRENT_REF" \
            --jq '[.[] | select(.rule.security_severity_level == "high" or .rule.security_severity_level == "critical")]')

          COUNT=$(echo "$ALERTS" | jq 'length')

          if [ "$COUNT" -gt 0 ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ ë³´ì•ˆ ê²€ì‚¬ ì‹¤íŒ¨: ê³ ìœ„í—˜(High/Critical) ì·¨ì•½ì  $COUNTê°œ ë°œê²¬"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "$ALERTS" | jq -r '.[] | "- [\(.rule.security_severity_level)] \(.rule.description) \n   ìœ„ì¹˜: \(.most_recent_instance.location.path)"'
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          else
            echo "âœ… ë³´ì•ˆ ê²€ì‚¬ í†µê³¼: í˜„ì¬ ì»¤ë°‹($CURRENT_REF)ì€ ì•ˆì „í•©ë‹ˆë‹¤."
          fi

  # 3. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR ì—…ë¡œë“œ
  build:
    needs: [lint, static-analysis]
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    outputs:
      image_tag: ${{ steps.timestamp.outputs.image_tag }}
      s3_key: ${{ steps.upload.outputs.s3_key }}
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: AWS ìê²© ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: íƒ€ì„ìŠ¤íƒ¬í”„ ë° ì´ë¯¸ì§€ íƒœê·¸ ìƒì„±
        id: timestamp
        run: |
          # SHAì˜ ì• 7ìë¦¬ë§Œ ë³€ìˆ˜ì— ì €ì¥
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          # ë‚ ì§œì™€ SHORT_SHAë¥¼ ê²°í•©í•˜ì—¬ OUTPUTì— ì €ì¥
          IMAGE_TAG="$(date +'%Y%m%d_%H%M%S')-$SHORT_SHA"
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        id: env
        run: |
          if [[ "${{ env.BRANCH_NAME }}" == release/* ]]; then
            echo "ENV_FILE<<EOF" >> $GITHUB_ENV
            echo "${{ secrets.ENV_FILE_STAGING }}" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "ENV_FILE<<EOF" >> $GITHUB_ENV
            echo "${{ secrets.ENV_FILE_DEV }}" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          fi

      - name: ECR ë¡œê·¸ì¸
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      - name: ë¹Œë“œìš© í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
        run: |
          # í™˜ê²½ ì´ë¦„ ê²°ì •
          if [[ "${{ env.BRANCH_NAME }}" == release/* ]]; then
            ENV_NAME="stg"
          else
            ENV_NAME="dev"
          fi

          # .env.production íŒŒì¼ ìƒì„± (NODE_ENV=productionì¼ ë•Œ Next.jsê°€ ì½ìŒ)
          echo "$ENV_FILE" > .env.production

          echo "ğŸ“ ë¹Œë“œìš© í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± ì™„ë£Œ"
          echo "í™˜ê²½: $ENV_NAME"
          echo "íŒŒì¼: .env.production (Docker ë¹Œë“œëŠ” í•­ìƒ NODE_ENV=production)"
          echo ""
          echo "íŒŒì¼ ë‚´ìš©:"
          cat .env.production

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR í‘¸ì‹œ
        env:
          IMAGE_TAG: ${{ steps.timestamp.outputs.image_tag }}
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/${{ env.ECR_TARGET_REPO }}:${{ env.IMAGE_TAG }}
            ${{ env.ECR_REGISTRY }}/${{ env.ECR_TARGET_REPO }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false

      - name: ë°°í¬ ì•„í‹°íŒ©íŠ¸ ìƒì„±
        id: upload
        env:
          IMAGE_TAG: ${{ steps.timestamp.outputs.image_tag }}
          ECR_REGISTRY: ${{ env.ECR_REGISTRY }}
          ECR_REPOSITORY: ${{ env.ECR_TARGET_REPO }}
        run: |
          set -euo pipefail

          ARTIFACT_NAME="deploy-$IMAGE_TAG.zip"
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT

          echo "ğŸ“¦ ë°°í¬ ì•„í‹°íŒ©íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤: $ARTIFACT_NAME"

          # ì„ì‹œ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p deploy-temp

          # CodeDeploy ì„¤ì • ë° ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬
          cp appspec.yml deploy-temp/
          cp -r scripts deploy-temp/

          # Docker Compose íŒŒì¼ ë³µì‚¬
          cp docker-compose.yml deploy-temp/
          cp promtail-config.yml deploy-temp/

          # í™˜ê²½ íŒŒì¼ëª… ê²°ì •
          if [[ "${{ env.BRANCH_NAME }}" == release/* ]]; then
            ENV_FILE_NAME=".env.stg"
          else
            ENV_FILE_NAME=".env.dev"
          fi

          echo "ğŸ“ í™˜ê²½ íŒŒì¼: $ENV_FILE_NAME"

          # ì´ë¯¸ì§€ ì •ë³´ íŒŒì¼ ìƒì„±
          cat > deploy-temp/image-info.env << EOF
          ECR_REGISTRY=$ECR_REGISTRY
          ECR_REPOSITORY=$ECR_REPOSITORY
          IMAGE_TAG=$IMAGE_TAG
          FULL_IMAGE=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          ENV_FILE=$ENV_FILE_NAME
          EOF

          # ëŸ°íƒ€ì„ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± (ë°°í¬ìš©)
          echo "ğŸ“ ëŸ°íƒ€ì„ìš© $ENV_FILE_NAME íŒŒì¼ ìƒì„± ì¤‘..."

          # NEXT_PUBLIC_ ë³€ìˆ˜ë“¤ë§Œ ì¶”ì¶œí•˜ì—¬ ëŸ°íƒ€ì„ìš© .env íŒŒì¼ ìƒì„±
          grep '^NEXT_PUBLIC_' .env.production > "deploy-temp/$ENV_FILE_NAME" || true

          echo "âœ… ìƒì„±ëœ ëŸ°íƒ€ì„ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ($ENV_FILE_NAME):"
          cat "deploy-temp/$ENV_FILE_NAME"

          # ì••ì¶• íŒŒì¼ ìƒì„±
          cd deploy-temp
          zip -r "../$ARTIFACT_NAME" . -q
          cd ..
          rm -rf deploy-temp

          # S3 ì—…ë¡œë“œ ê²½ë¡œ ì„¤ì •
          S3_KEY="${{ env.S3_PREFIX }}/$ARTIFACT_NAME"
          S3_URL="s3://${{ env.S3_BUCKET }}/$S3_KEY"
          echo "s3_key=$S3_KEY" >> $GITHUB_OUTPUT

          echo "ğŸš€ $ARTIFACT_NAMEì„ $S3_URLë¡œ ì—…ë¡œë“œí•©ë‹ˆë‹¤..."

          # S3ì— ì••ì¶• íŒŒì¼ ì—…ë¡œë“œ
          aws s3 cp "$ARTIFACT_NAME" "$S3_URL" --only-show-errors

          echo "âœ… S3 ì—…ë¡œë“œ ì™„ë£Œ: $S3_URL"

  # 4. CodeDeploy ë°°í¬
  deploy:
    needs: [build]
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    outputs:
      deployment_id: ${{ steps.create.outputs.deployment_id }}
      deployment_status: ${{ steps.result.outputs.status }}
      deployment_error: ${{ steps.result.outputs.error_message }}
    steps:
      - name: AWS ìê²© ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: AWS CodeDeploy ë°°í¬ ì‹œì‘
        id: create
        run: |
          set -euo pipefail
          echo "ğŸš€ CodeDeploy ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."

          DEPLOYMENT_ID=$(aws deploy create-deployment \
            --application-name "${{ env.CODEDEPLOY_APP_NAME }}" \
            --deployment-group-name "${{ env.CODEDEPLOY_DEPLOYMENT_GROUP }}" \
            --s3-location bucket="${{ env.S3_BUCKET }}",key="${{ needs.build.outputs.s3_key }}",bundleType=zip \
            --description "Deploy Docker Image: ${{ env.ECR_REGISTRY }}/${{ env.ECR_TARGET_REPO }}:${{ needs.build.outputs.image_tag }}" \
            --query 'deploymentId' \
            --output text)

          echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          echo "âœ… ë°°í¬ ID: $DEPLOYMENT_ID"

      - name: ë°°í¬ ì™„ë£Œ(í—¬ìŠ¤ì²´í¬ í¬í•¨)ê¹Œì§€ ëŒ€ê¸°
        id: wait
        run: |
          set -euo pipefail
          DEPLOYMENT_ID="${{ steps.create.outputs.deployment_id }}"
          echo "â³ ë°°í¬ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤ (ID: $DEPLOYMENT_ID)..."

          # ë°°í¬ ì™„ë£Œê¹Œì§€ ëŒ€ê¸° (ìµœëŒ€ 3ë¶„)
          aws deploy wait deployment-successful \
            --deployment-id "$DEPLOYMENT_ID" \
            --cli-read-timeout 180

          echo "âœ… CodeDeploy ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"

      - name: ë°°í¬ ê²°ê³¼ ì¡°íšŒ
        id: result
        if: always()
        run: |
          set -euo pipefail

          DEPLOYMENT_ID="${{ steps.create.outputs.deployment_id }}"
          if [ -z "${DEPLOYMENT_ID:-}" ]; then
            echo "status=UNKNOWN" >> $GITHUB_OUTPUT
            echo "error_message=Failed to create deployment (deployment_id missing)" >> $GITHUB_OUTPUT
            exit 0
          fi

          STATUS=$(aws deploy get-deployment --deployment-id "$DEPLOYMENT_ID" --query 'deploymentInfo.status' --output text)
          ERROR_MESSAGE=$(aws deploy get-deployment --deployment-id "$DEPLOYMENT_ID" --query 'deploymentInfo.errorInformation.message' --output text 2>/dev/null || true)

          if [ "${ERROR_MESSAGE:-}" = "None" ] || [ "${ERROR_MESSAGE:-}" = "null" ]; then
            ERROR_MESSAGE=""
          fi

          ERROR_MESSAGE_CLEAN=$(echo "${ERROR_MESSAGE:-}" | tr '\n' ' ' | head -c 400)

          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "error_message=$ERROR_MESSAGE_CLEAN" >> $GITHUB_OUTPUT

          echo "ğŸ“Œ ìµœì¢… ìƒíƒœ: $STATUS"
          if [ -n "$ERROR_MESSAGE_CLEAN" ]; then
            echo "ğŸ“Œ ì—ëŸ¬: $ERROR_MESSAGE_CLEAN"
          fi

  # 5. CI ë””ìŠ¤ì½”ë“œ ì•Œë¦¼
  notify-ci:
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    needs: [lint, static-analysis, build]
    if: always()
    steps:
      - name: Discord ì•Œë¦¼ ì „ì†¡
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ env.DISCORD_WEBHOOK_URL }}
          status: ${{ (needs.lint.result == 'success' && needs.static-analysis.result == 'success' && needs.build.result == 'success') && 'success' || 'failure' }}
          title: "${{ env.BRANCH_NAME }} CI ê²°ê³¼ [${{ (needs.lint.result == 'success' && needs.static-analysis.result == 'success' && needs.build.result == 'success') && 'âœ…ì„±ê³µ' || 'âŒì‹¤íŒ¨' }}]"
          description: |
            **ë¸Œëœì¹˜**: `${{ env.BRANCH_NAME }}`
            **í™˜ê²½**: ${{ env.ENV_TYPE }}

            **ğŸ“Š ìƒì„¸ ê²°ê³¼**:
            - Lint/Type: ${{ needs.lint.result == 'success' && ' âœ…' || ' âŒ' }}
            - Static Analysis: ${{ needs.static-analysis.result == 'success' && ' âœ…' || ' âŒ' }}
            - Build: ${{ needs.build.result == 'success' && ' âœ…' || ' âŒ' }}

            **ğŸ³ Docker ì´ë¯¸ì§€**: `${{ needs.build.outputs.image_tag }}`
            **ğŸª£ S3 Key**: `${{ needs.build.outputs.s3_key }}`

            **ğŸ”— ë§í¬**: [ì»¤ë°‹ í™•ì¸í•˜ê¸°](${{ github.event.repository.html_url }}/commit/${{ github.sha }})

          color: "${{ (needs.lint.result == 'success' && needs.static-analysis.result == 'success' && needs.build.result == 'success') && 65280 || 16711680 }}"
          username: GitHub FE NonProd Merge Bot
          avatar_url: ${{ env.DISCORD_AVATAR_URL }}

  # 6. CD ë””ìŠ¤ì½”ë“œ ì•Œë¦¼
  notify-cd:
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    needs: [build, deploy]
    if: always()
    steps:
      - name: Discord ì•Œë¦¼ ì „ì†¡
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ env.DISCORD_WEBHOOK_URL }}
          status: ${{ needs.deploy.result == 'success' && 'success' || 'failure' }}
          title: "${{ env.BRANCH_NAME }} CD ê²°ê³¼ [${{ needs.deploy.result == 'success' && 'âœ…ì„±ê³µ' || 'âŒì‹¤íŒ¨' }}]"
          description: |
            **ë¸Œëœì¹˜**: `${{ env.BRANCH_NAME }}`
            **í™˜ê²½**: ${{ env.ENV_TYPE }}

            **ğŸ³ Docker ì´ë¯¸ì§€**: `${{ needs.build.outputs.image_tag }}`
            **ğŸª£ S3 Key**: `${{ needs.build.outputs.s3_key }}`
            **ğŸš€ ë°°í¬ ê²°ê³¼**: ${{ needs.deploy.outputs.deployment_status || needs.deploy.result }}
            **ğŸ†” Deployment ID**: `${{ needs.deploy.outputs.deployment_id }}`
            **ğŸ§¾ ì—ëŸ¬**: ${{ needs.deploy.outputs.deployment_error || 'ì—†ìŒ' }}

            **ğŸ”— ë§í¬**: [ì»¤ë°‹ í™•ì¸í•˜ê¸°](${{ github.event.repository.html_url }}/commit/${{ github.sha }})

          color: "${{ needs.deploy.result == 'success' && 65280 || 16711680 }}"
          username: GitHub FE NonProd Deploy Bot
          avatar_url: ${{ env.DISCORD_AVATAR_URL }}

  # 7. E2E í…ŒìŠ¤íŠ¸ (ë°°í¬ ì„±ê³µ ì‹œ ì‹¤í–‰)
  e2e-test:
    needs: [deploy]
    if: startsWith(github.ref_name, 'release/')
    uses: ./.github/workflows/devths-playwright.yml
    with:
      target_url: 'https://stg.devths.com'
    secrets:
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_NON_PROD_URL }}
