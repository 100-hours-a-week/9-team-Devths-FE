name: Devths-FE ìš´ì˜ ë°°í¬

on:
  workflow_dispatch:
    inputs:
      artifact_key:
        description: 'S3 ì•„í‹°íŒ©íŠ¸ í‚¤ (ì˜ˆ: FE/main/20250127_123456-abc1234.zip)'
        required: true
        type: string
      deployment_comment:
        description: 'ë°°í¬ ë©”ëª¨'
        required: false
        type: string
        default: 'Manual deployment from GitHub Actions'

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  S3_BUCKET: ${{ secrets.AWS_S3_BUCKET_PROD }}
  CODEDEPLOY_APP_NAME: ${{ secrets.CODEDEPLOY_APP_NAME }}
  CODEDEPLOY_DEPLOYMENT_GROUP: ${{ secrets.CODE_DEPLOY_GROUP_NAME_PROD }}

jobs:
  # ìŠ¹ì¸ ìš”ì²­ ì•Œë¦¼ (ì¦‰ì‹œ ì‹¤í–‰)
  notify-approval-request:
    name: Notify Approval Request
    runs-on: ubuntu-22.04
    steps:
      - name: Discord ìŠ¹ì¸ ìš”ì²­ ì•Œë¦¼
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_PROD_URL }}
          status: ${{ github.event_name }}
          title: 'ğŸ”” ìš´ì˜ ë°°í¬ ìŠ¹ì¸ ìš”ì²­'
          description: |
            **ë°°í¬ ìš”ì²­ì**: ${{ github.actor }}
            **ìš”ì²­ ì‹œê°**: ${{ github.event.created_at }}

            **ğŸ“¦ ì•„í‹°íŒ©íŠ¸**: `${{ inputs.artifact_key }}`
            **ğŸ’¬ ë°°í¬ ë©”ëª¨**: ${{ inputs.deployment_comment }}
            **ğŸŒ í™˜ê²½**: ğŸš€ ìš´ì˜(PROD)

            â³ **2ë‹¨ê³„ êµì°¨ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘...**

            **ìŠ¹ì¸ í”„ë¡œì„¸ìŠ¤**:
            1ï¸âƒ£ **1ì°¨ ìŠ¹ì¸** (DevOps/TechLead) â†’ 2ï¸âƒ£ **2ì°¨ ìŠ¹ì¸** (TeamLead) â†’ ğŸš€ **ë°°í¬ ì‹¤í–‰**

            **ìŠ¹ì¸ ë°©ë²•**:
            1. [ì›Œí¬í”Œë¡œìš° í˜ì´ì§€](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})ë¡œ ì´ë™
            2. **Review deployments** ë²„íŠ¼ í´ë¦­
            3. ë³¸ì¸ì˜ ìŠ¹ì¸ ë‹¨ê³„ ì„ íƒ í›„ **Approve and deploy** í´ë¦­

            **âš ï¸ ì£¼ì˜**: 2ëª… ëª¨ë‘ ìŠ¹ì¸í•´ì•¼ ë°°í¬ê°€ ì‹œì‘ë©ë‹ˆë‹¤.
          color: 16776960
          username: GitHub FE Approval Bot
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png

  # 1ì°¨ ìŠ¹ì¸
  first-approval:
    name: 1ì°¨ ìŠ¹ì¸ (DevOps/TechLead)
    runs-on: ubuntu-22.04
    needs: [notify-approval-request]
    environment:
      name: production-approval-1
    steps:
      - name: 1ì°¨ ìŠ¹ì¸ ì™„ë£Œ
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… 1ì°¨ ìŠ¹ì¸ ì™„ë£Œ"
          echo "ìŠ¹ì¸ì: ${{ github.actor }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # 2ì°¨ ìŠ¹ì¸
  second-approval:
    name: 2ì°¨ ìŠ¹ì¸ (TeamLead)
    runs-on: ubuntu-22.04
    needs: [first-approval]
    environment:
      name: production-approval-2
    steps:
      - name: 2ì°¨ ìŠ¹ì¸ ì™„ë£Œ
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… 2ì°¨ ìŠ¹ì¸ ì™„ë£Œ - ë°°í¬ ì‹œì‘ ê°€ëŠ¥"
          echo "ìŠ¹ì¸ì: ${{ github.actor }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # ìš´ì˜ ë°°í¬ (2ì°¨ ìŠ¹ì¸ í›„ ìë™ ì‹¤í–‰)
  deploy-production:
    name: Production Deployment
    runs-on: ubuntu-22.04
    needs: [second-approval]
    environment:
      name: production
      url: https://www.devths.com
    outputs:
      deployment_id: ${{ steps.deploy.outputs.deployment_id }}
      deployment_status: ${{ steps.deploy.outputs.deployment_status }}
      deployment_error: ${{ steps.deploy.outputs.deployment_error }}

    steps:
      - name: ë°°í¬ ì •ë³´ í™•ì¸
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Production Deployment Information"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Artifact: ${{ inputs.artifact_key }}"
          echo "ğŸª£ S3 Bucket: ${{ env.S3_BUCKET }}"
          echo "ğŸ¯ Deployment Group: ${{ env.CODEDEPLOY_DEPLOYMENT_GROUP }}"
          echo "ğŸ’¬ Comment: ${{ inputs.deployment_comment }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: AWS ìê²© ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: S3 ì•„í‹°íŒ©íŠ¸ ì¡´ì¬ í™•ì¸
        run: |
          echo "ğŸ” Checking if artifact exists in S3..."
          if aws s3 ls "s3://${{ env.S3_BUCKET }}/${{ inputs.artifact_key }}" > /dev/null 2>&1; then
            echo "âœ… Artifact found: s3://${{ env.S3_BUCKET }}/${{ inputs.artifact_key }}"

            # íŒŒì¼ í¬ê¸° í™•ì¸
            SIZE=$(aws s3 ls "s3://${{ env.S3_BUCKET }}/${{ inputs.artifact_key }}" | awk '{print $3}')
            SIZE_MB=$(echo "scale=2; $SIZE/1024/1024" | bc)
            echo "ğŸ“Š Artifact size: ${SIZE_MB}MB"
          else
            echo "âŒ Artifact not found: s3://${{ env.S3_BUCKET }}/${{ inputs.artifact_key }}"
            echo "ğŸ’¡ Please check the artifact key and try again."
            exit 1
          fi

      - name: CodeDeploy ë°°í¬ ì‹œì‘
        id: deploy
        run: |
          echo "ğŸš€ Starting deployment to Production..."

          DEPLOYMENT_ID=$(aws deploy create-deployment \
            --application-name ${{ env.CODEDEPLOY_APP_NAME }} \
            --deployment-group-name ${{ env.CODEDEPLOY_DEPLOYMENT_GROUP }} \
            --s3-location bucket=${{ env.S3_BUCKET }},key=${{ inputs.artifact_key }},bundleType=zip \
            --description "${{ inputs.deployment_comment }} (by ${{ github.actor }})" \
            --query 'deploymentId' \
            --output text)

          echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          echo "âœ… Deployment started: $DEPLOYMENT_ID"
          echo "ğŸ”— AWS Console: https://${{ env.AWS_REGION }}.console.aws.amazon.com/codesuite/codedeploy/deployments/$DEPLOYMENT_ID"

          # ë°°í¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§
          echo ""
          echo "â³ Monitoring deployment progress..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if aws deploy wait deployment-successful --deployment-id $DEPLOYMENT_ID; then
            echo "deployment_status=Success" >> $GITHUB_OUTPUT
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Deployment completed successfully!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          else
            ERROR_MSG=$(aws deploy get-deployment --deployment-id $DEPLOYMENT_ID --query 'deploymentInfo.errorInformation.message' --output text 2>&1 || echo "Unknown error")
            echo "deployment_status=Failed" >> $GITHUB_OUTPUT
            echo "deployment_error=$ERROR_MSG" >> $GITHUB_OUTPUT
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ Deployment failed: $ERROR_MSG"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          fi

  # Discord ì•Œë¦¼
  notify-discord:
    runs-on: ubuntu-22.04
    needs: [deploy-production]
    if: always()
    steps:
      - name: Discord ì•Œë¦¼ ì „ì†¡
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_PROD_URL }}
          status: ${{ needs.deploy-production.result == 'success' && 'success' || 'failure' }}
          title: "ğŸš€ ìš´ì˜ ë°°í¬ ê²°ê³¼ [${{ needs.deploy-production.result == 'success' && 'âœ…ì„±ê³µ' || 'âŒì‹¤íŒ¨' }}]"
          description: |
            **ë°°í¬ íƒ€ì…**: ìˆ˜ë™ ë°°í¬ (Manual)
            **í™˜ê²½**: ğŸš€ ìš´ì˜(PROD)
            **íŠ¸ë¦¬ê±°**: ${{ github.actor }}

            **ğŸ“¦ ì•„í‹°íŒ©íŠ¸**: `${{ inputs.artifact_key }}`
            **ğŸª£ S3 Bucket**: `${{ secrets.AWS_S3_BUCKET_PROD }}`
            **ğŸš€ ë°°í¬ ê²°ê³¼**: ${{ needs.deploy-production.outputs.deployment_status }}
            **ğŸ†” Deployment ID**: `${{ needs.deploy-production.outputs.deployment_id }}`
            **ğŸ’¬ ë°°í¬ ë©”ëª¨**: ${{ inputs.deployment_comment }}
            **ğŸ§¾ ì—ëŸ¬**: ${{ needs.deploy-production.outputs.deployment_error || 'ì—†ìŒ' }}

            **ğŸ”— ë§í¬**: [ì›Œí¬í”Œë¡œìš° í™•ì¸í•˜ê¸°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          color: "${{ needs.deploy-production.result == 'success' && 65280 || 16711680 }}"
          username: GitHub FE Production Deploy Bot
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
