name: Devths-FE CI íŒŒì´í”„ë¼ì¸

on:
  pull_request:
    branches: [develop, release, main]

env:
  NODE_VERSION: '22.x'

jobs:
  # 1. í†µí•© í’ˆì§ˆ ê²€ì‚¬ (Lint + Prettier + TypeCheck)
  lint:
    runs-on: ubuntu-22.04
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v3
        with:
          version: 9 # í”„ë¡œì íŠ¸ í™˜ê²½ì— ë§ëŠ” ë²„ì „ ì„¤ì •
          run_install: false

      - name: ë…¸ë“œ JS ì„¤ì¹˜
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: í†µí•© ì½”ë“œ ê²€ì‚¬
        run: pnpm check # í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•˜ë©´ ì—¬ê¸°ì„œ ë©ˆì¶¤

  # 2. ì •ì  ë¶„ì„ (CodeQL)
  static-analysis:
    runs-on: ubuntu-22.04
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: CodeQL ì´ˆê¸°í™”
        uses: github/codeql-action/init@v4
        with:
          languages: javascript-typescript

      - name: ë¶„ì„ ìˆ˜í–‰
        uses: github/codeql-action/analyze@v4

      - name: ë³´ì•ˆ ì·¨ì•½ì  í™•ì¸ ë° ë¹Œë“œ ì°¨ë‹¨
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TARGET_REF="refs/pull/${{ github.event.pull_request.number }}/merge"
          echo "ğŸ“ ë¶„ì„ ëŒ€ìƒ Ref: $TARGET_REF"
          
          ALERTS_JSON=""
          for i in {1..10}; do
            # FE í”„ë¡œì íŠ¸ì˜ CodeQL ë¶„ì„ ê²°ê³¼ ì¡°íšŒ
            RESPONSE=$(gh api "repos/${{ github.repository }}/code-scanning/alerts?tool_name=CodeQL&state=open&ref=$TARGET_REF" || echo "")
          
            if [ -n "$RESPONSE" ] && [ "$RESPONSE" != "[]" ]; then
              ALERTS_JSON="$RESPONSE"
              echo "âœ… ë°ì´í„° ë°˜ì˜ ì™„ë£Œ!"
              break
            fi
            echo "â³ ë°ì´í„° ë°˜ì˜ ëŒ€ê¸° ì¤‘... ($((i*5))s)"
            sleep 5
          done
          
          if [ -z "$ALERTS_JSON" ] || [ "$ALERTS_JSON" == "[]" ]; then
            echo "âœ… ë°œê²¬ëœ ë³´ì•ˆ ì·¨ì•½ì ì´ ì—†ìŠµë‹ˆë‹¤."
            exit 0
          fi
          
          # ì·¨ì•½ì  ê°œìˆ˜ ê³„ì‚° (vulnerable í´ë” ì œì™¸ ë¡œì§ì´ í•„ìš”í•˜ë©´ ì—¬ê¸°ì— ì¶”ê°€ ê°€ëŠ¥)
          ALERTS_COUNT=$(echo "$ALERTS_JSON" | jq -r "[.[] | select(.rule.security_severity_level != null)] | length")
          
          if [ "$ALERTS_COUNT" -gt 0 ]; then
            echo "âš ï¸ ë³´ì•ˆ ì·¨ì•½ì  $ALERTS_COUNTê°œ ë°œê²¬"
            echo "$ALERTS_JSON" | jq -r '.[] | select(.rule.security_severity_level != null) | "  - [\(.rule.security_severity_level)] \(.rule.description) \n    ê²½ë¡œ: \(.most_recent_instance.location.path)"'
            echo "âŒ ë³´ì•ˆ ê²€ì‚¬ ì‹¤íŒ¨: ì·¨ì•½ì ì„ í•´ê²°í•´ì•¼ ë¨¸ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            exit 1
          fi

  # 3. ë¹Œë“œ í…ŒìŠ¤íŠ¸
  build:
    name: build
    needs: [lint, static-analysis]
    runs-on: ubuntu-22.04
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: ë…¸ë“œ JS ì„¤ì¹˜
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: í”„ë¡œì íŠ¸ ë¹Œë“œ
        run: pnpm build

  # 4. ë””ìŠ¤ì½”ë“œ í†µí•© ì•Œë¦¼
  notify-discord:
    runs-on: ubuntu-22.04
    needs: [lint, static-analysis, build]
    if: always()
    steps:
      - name: ë°ì´í„° ì¤€ë¹„
        id: prep
        env:
          USER_MAP: ${{ secrets.USER_MAP_JSON }}
        run: |
          # 1. ì‘ì„±ì ë©˜ì…˜í™”
          LOGIN_ID="${{ github.event.pull_request.user.login }}"
          AUTHOR_RAW=$(echo "$USER_MAP" | jq -r --arg id "$LOGIN_ID" '.[$id] // $id')
          [[ $AUTHOR_RAW =~ (<@[^>]+>) ]] && AUTHOR_TAG="${BASH_REMATCH[1]}" || AUTHOR_TAG="$AUTHOR_RAW"
          echo "author=$AUTHOR_TAG" >> $GITHUB_OUTPUT

          # 2. ë¦¬ë·°ì–´ ë©˜ì…˜í™”
          REVIEWERS_JSON='${{ toJson(github.event.pull_request.requested_reviewers) }}'
          REVIEWER_TAGS=$(echo "$REVIEWERS_JSON" | jq -r --argjson map "$USER_MAP" '
            [.[].login | ($map[.] // .)] 
            | map(if test("<@[^>]+>") then sub(".*(?=<@)"; "") | sub("(?<=>).*"; "") else . end)
            | join(", ")
          ')
          echo "reviewers=${REVIEWER_TAGS:-ì—†ìŒ}" >> $GITHUB_OUTPUT

          # 3. ì‘ì—… ë‚´ìš© ìš”ì•½ (ì •ê·œì‹ ìˆ˜ì • ì™„ë£Œ)
          PR_RAW_BODY=$(cat << 'EOF'
          ${{ github.event.pull_request.body }}
          EOF
          )
          DESC=$(echo "$PR_RAW_BODY" | \
            perl -0777 -pe 's///gs' | \
            sed 's/ì´ PRì—ì„œ ë³€ê²½ëœ ë‚´ìš©ì„ ê°„ëµíˆ ì‘ì„±í•´ì£¼ì„¸ìš”\.//g' | \
            sed -n '/## ğŸ“Œ ì‘ì—…í•œ ë‚´ìš©/,/## ğŸ” ì°¸ê³  ì‚¬í•­/p' | \
            sed '1d;$d' | \
            xargs | \
            head -c 300)
          echo "description=${DESC:-ë‚´ìš© ì—†ìŒ}" >> $GITHUB_OUTPUT

      - name: Discord ì•Œë¦¼ ì „ì†¡
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: ${{ (needs.lint.result == 'success' && needs.static-analysis.result == 'success' && needs.build.result == 'success') && 'success' || 'failure' }}
          title: "${{ github.event.pull_request.base.ref }} FE PR [${{ (needs.lint.result == 'success' && needs.static-analysis.result == 'success' && needs.build.result == 'success') && 'âœ…ì„±ê³µ' || 'âŒì‹¤íŒ¨' }}]"
          description: |
            **PR ì œëª©**: ${{ github.event.pull_request.title }}
            **ì‘ì„±ì**: ${{ steps.prep.outputs.author }}
            **ë¦¬ë·°ì–´**: ${{ steps.prep.outputs.reviewers }}
            **ì‘ì—… ë‚´ìš©**: ${{ steps.prep.outputs.description }}...
            **ê²½ë¡œ**: `${{ github.event.pull_request.head.ref }}` â†’ `${{ github.event.pull_request.base.ref }}`

            **ğŸ“Š ìƒì„¸ ê²°ê³¼**:
            - Lint/Type: ${{ needs.lint.result == 'success' && ' âœ…' || ' âŒ' }}
            - Static Analysis: ${{ needs.static-analysis.result == 'success' && ' âœ…' || ' âŒ' }}
            - Build: ${{ needs.build.result == 'success' && ' âœ…' || ' âŒ' }}

            **ğŸ”— ë§í¬**: [PR í™•ì¸í•˜ê¸°](${{ github.event.pull_request.html_url }})
          color: "${{ (needs.lint.result == 'success' && needs.static-analysis.result == 'success' && needs.build.result == 'success') && 65280 || 16711680 }}"
          username: GitHub FE Bot
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
